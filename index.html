<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SHOWING</title>

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%93%B1%3C/text%3E%3C/svg%3E">

  <meta name="theme-color" content="#000000" />

  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; margin: 0; background: #000; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }

    .screen {
      position: fixed; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 16px;
      padding: 24px;
      box-sizing: border-box;
      background: #000;
      color: #fff;
      text-align: center;
    }

    .hidden { display: none !important; }

    button {
      font-size: 20px;
      padding: 14px 18px;
      border-radius: 14px;
      border: 1px solid #444;
      background: #111;
      color: #fff;
    }
    button:active { transform: translateY(1px); }

    .hint { opacity: 0.75; max-width: 42rem; line-height: 1.35; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    #stage {
      position: fixed; inset: 0;
      background: #000;
      color: #fff;
    }

    /* Centered stacked layer */
    #layer {
      position: absolute; inset: 0;
      display: grid;
      place-items: center;
      text-align: center;
      padding: 24px;
      box-sizing: border-box;
    }

    #textCue, #audioCue, #voteWrap {
      grid-area: 1 / 1;
    }

    #textCue {
      white-space: pre-wrap;
      line-height: 1.08;
      width: 100%;
      /* word breaking is controlled dynamically via JS */
    }

    #imgCue {
      position: absolute; inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }

    #audioCue {
      display: none;
      font-size: 96px;
      line-height: 1;
    }

    /* Vote UI */
    #voteWrap {
      display: none;
      width: min(920px, 100%);
      padding: 16px;
      box-sizing: border-box;
    }

    #voteGrid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      align-items: stretch;
    }

    .voteBtn {
      width: 100%;
      font-size: 22px;
      padding: 18px 16px;
      border-radius: 18px;
      border: 1px solid #555;
      background: #0f0f0f;
      color: #fff;
      line-height: 1.15;
      white-space: normal;
      word-break: break-word;
      min-height: 68px;
    }

    .voteBtn:active { transform: translateY(1px); }

    /* Debug UI */
    #debugWrap {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.65);
      color: rgba(255,255,255,0.88);
      font-size: 12px;
      box-sizing: border-box;
      backdrop-filter: blur(6px);
      border-top: 1px solid rgba(255,255,255,0.12);
    }

    #debugBar {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
    }

    #debugLog {
      max-height: 34vh;
      overflow: auto;
      padding: 0 12px 10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space: pre-wrap;
      line-height: 1.25;
      opacity: 0.95;
    }

    .safePad {
      padding-bottom: calc(24px + env(safe-area-inset-bottom));
      padding-top: calc(24px + env(safe-area-inset-top));
    }
  </style>
</head>

<body>
  <div id="welcome" class="screen safePad">
    <div id="welcomeTitle" style="font-size: 22px; font-weight: 650;">SHOWING</div>
    <div id="welcomeInfo" class="hint"></div>
    <button id="startBtn">Sind Sie bereit?</button>
    <div id="welcomeTip" class="hint">
      Tip: <span class="mono">?p=1</span>, <span class="mono">?p=2</span>, â€¦ or <span class="mono">?p=random</span>.
      Add <span class="mono">&debug=true</span> for diagnostics.
    </div>
    <div id="welcomeError" class="hint" style="color:#ffb3b3;"></div>
  </div>

  <div id="stage" class="hidden">
    <img id="imgCue" alt="" />
    <div id="layer" class="safePad" aria-live="polite">
      <div id="textCue"></div>
      <div id="audioCue" aria-hidden="true">ðŸ”Š</div>

      <div id="voteWrap">
        <div id="voteGrid"></div>
      </div>
    </div>
  </div>

  <div id="debugWrap" class="hidden">
    <div id="debugBar">
      <div id="dbgLeft"></div>
      <div id="dbgRight"></div>
    </div>
    <div id="debugLog"></div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  function parseQuery() {
    const u = new URL(window.location.href);
    const dbg = (u.searchParams.get("debug") || "").toLowerCase();
    const pRaw = (u.searchParams.get("p") || "1").toLowerCase().trim();
    const overlapRaw = (u.searchParams.get("overlap") || "no").toLowerCase().trim();
    const refreshRaw = (u.searchParams.get("refresh") || "").trim();
    const breakRaw = (u.searchParams.get("breakwords") || "no").toLowerCase().trim();

    const refreshSeconds = (() => {
      const n = Number(refreshRaw);
      return Number.isFinite(n) && n > 0 ? n : 0;
    })();

    return {
      csv: u.searchParams.get("csv") || "",
      pRaw,
      debug: (dbg === "1" || dbg === "true" || dbg === "yes"),
      overlap: (overlapRaw === "1" || overlapRaw === "true" || overlapRaw === "yes"),
      refreshSeconds,
      breakWords: (breakRaw === "1" || breakRaw === "true" || breakRaw === "yes"),
      voteUrl: u.searchParams.get("vote") || "",
      showId: u.searchParams.get("show") || ""
    };
  }

  const els = {
    welcome: $("welcome"),
    welcomeTitle: $("welcomeTitle"),
    welcomeInfo: $("welcomeInfo"),
    welcomeTip: $("welcomeTip"),
    welcomeError: $("welcomeError"),
    startBtn: $("startBtn"),
    stage: $("stage"),
    layer: $("layer"),
    textCue: $("textCue"),
    imgCue: $("imgCue"),
    audioCue: $("audioCue"),
    voteWrap: $("voteWrap"),
    voteGrid: $("voteGrid"),
    debugWrap: $("debugWrap"),
    dbgLeft: $("dbgLeft"),
    dbgRight: $("dbgRight"),
    debugLog: $("debugLog"),
  };

  function applyBreakWordMode(q) {
    if (q.breakWords) {
      els.textCue.style.wordBreak = "break-word";
      els.textCue.style.overflowWrap = "anywhere";
    } else {
      els.textCue.style.wordBreak = "normal";
      els.textCue.style.overflowWrap = "normal";
    }
  }

  function fitTextToBox(text) {
    els.textCue.textContent = text;

    const boxW = els.layer.clientWidth - 48;
    const boxH = els.layer.clientHeight - 48;

    let lo = 10, hi = 240, best = lo;
    while (lo <= hi) {
      const mid = Math.floor((lo + hi) / 2);
      els.textCue.style.fontSize = mid + "px";
      const r = els.textCue.getBoundingClientRect();
      const fits = (r.width <= boxW + 1) && (r.height <= boxH + 1);
      if (fits) { best = mid; lo = mid + 1; }
      else { hi = mid - 1; }
    }
    els.textCue.style.fontSize = best + "px";
  }

  async function run() {
    const q = parseQuery();
    applyBreakWordMode(q);

    if (q.debug) els.debugWrap.classList.remove("hidden");
    else els.debugWrap.classList.add("hidden");

    if (q.debug) {
      els.welcomeInfo.innerHTML =
        `breakwords: <span class="mono">${q.breakWords ? "yes" : "no"}</span><br>
         overlap: <span class="mono">${q.overlap ? "yes" : "no"}</span><br>
         refresh: <span class="mono">${q.refreshSeconds > 0 ? q.refreshSeconds : "(none)"}</span>`;
    }

    // everything else continues unchanged...
  }

  run();
})();
</script>
</body>
</html>
